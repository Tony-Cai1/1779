apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: lms-api
  namespace: argocd
  # Add finalizer to ensure proper cleanup
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  source:
    # Repository URL - update this to your actual repository
    repoURL: https://github.com/Tony-Cai1/1779
    # Branch to sync from
    targetRevision: main
    # Path to Kubernetes manifests
    path: k8s
    # Helm values (if using Helm, otherwise omit)
    # helm:
    #   valueFiles:
    #     - values.yaml

  destination:
    # Cluster where to deploy (use 'in-cluster' for same cluster as ArgoCD)
    server: https://kubernetes.default.svc
    # Namespace to deploy to
    namespace: default

  syncPolicy:
    # Automated sync configuration
    automated:
      # Prune resources that are no longer in Git
      prune: true
      # Self-heal: automatically sync if cluster state drifts from Git
      selfHeal: true
      # Allow empty: allow apps with no resources
      allowEmpty: false
    # Sync options
    syncOptions:
      # Create namespace if it doesn't exist
      - CreateNamespace=true
      # Prune last: delete resources last during sync
      - PruneLast=true
      # Respect ignore differences
      - RespectIgnoreDifferences=true
    # Retry configuration
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Ignore differences for fields that are auto-generated or managed externally
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        # Ignore image tag changes (ArgoCD will sync from Git)
        - /spec/template/spec/containers/0/image
    - group: ""
      kind: Service
      jsonPointers:
        # Ignore LoadBalancer IP (managed by cloud provider)
        - /status/loadBalancer

  # Health check configuration
  healthChecks:
    - apiVersion: v1
      kind: Service
      name: lms-api-service
      namespace: default
    - apiVersion: apps/v1
      kind: Deployment
      name: lms-api
      namespace: default

